pipeline {
  agent any
  stages {

stage('BUILD') {
      steps {
        sh 'mvn clean install -DskipTests'
        archiveArtifacts 'target/*.jar'
      }
    }

 stage('TEST') {
      steps {
        sh 'mvn test jacoco:report'
        archiveArtifacts 'TEST*.xml,test*.xml'
        publishHTML([allowMissing: false, alwaysLinkToLastBuild: true, keepAll: false, reportDir: 'target/surefire-reports/', reportFiles: 'index.html', reportName: 'Test Report', reportTitles: 'Test Report'])
        publishHTML([allowMissing: false, alwaysLinkToLastBuild: true, keepAll: false, reportDir: 'target/site/jacoco/', reportFiles: 'index.html', reportName: 'TestCode Coverage', reportTitles: 'Coverage Report'])
        //Tests microservice and publishes the test and coverage report. 
          }
    }
    stage('STAGE') 
    {
      steps {
        sh '/var/lib/jenkins/workspace/trigger.sh'
        }
    }

    stage('PACT') {
      steps {
        sh 'mvn au.com.dius:pact-jvm-provider-maven_2.11:verify'
      }
    }
    
  
    stage('PERF') {
      steps {
        sh 'echo "PERF"'
        sh 'echo "PERF-TESTS"'
        sh 'mvn gatling:test'
        gatlingArchive()
        //Runs Perf Tests against the microservice for bench marking purposes.
      }
    }
  }
  tools {
    maven 'jenkins_maven'
  }
  }